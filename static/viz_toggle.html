<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PSN Viewer â€“ Toggles</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 0; background: #0b1220; color: #e8eefc; }
    .bar { display:flex; gap:8px; padding:10px; border-bottom:1px solid #223; position: sticky; top:0; background:#0b1220; }
    button { padding:8px 12px; border-radius:10px; border:1px solid #334; background:#141c2e; color:#e8eefc; cursor:pointer }
    button.active { outline:2px solid #6aa0ff }
    .row { display:flex; align-items:center; gap:12px; }
    .spacer { flex:1 }
    iframe { width:100%; height: calc(100vh - 54px); border:0; background:#000 }
    input[type="text"] { width: 360px; background:#0f1626; color:#e8eefc; border:1px solid #334; border-radius:8px; padding:6px 8px; }
    .tiny { font-size:12px; opacity:.8 }
  </style>
</head>
<body>
  <div class="bar">
    <div class="row">
      <button id="btnCartoon">Cartoon</button>
      <button id="btnOverlay" class="active">Overlay</button>
      <button id="btnBall">Ball-and-Stick</button>
    </div>
    <div class="spacer"></div>
    <div class="row tiny">
      <span>Top-k:</span><input id="topk" type="text" value="">
      <span>kmin:</span><input id="kmin" type="text" value="">
      <button id="apply">Apply</button>
    </div>
  </div>
  <iframe id="view" src=""></iframe>

  <script>
    const qs = new URLSearchParams(location.search);
    // Required
    const pdb_path   = qs.get("pdb_path")   || "";
    const edges_csv  = qs.get("edges_csv")  || "";
    if(!pdb_path || !edges_csv){
      document.body.innerHTML = "<div style='padding:20px;color:#fff'>Missing required params: pdb_path & edges_csv</div>";
    }

    // Optional (with sensible defaults)
    const baseStyle  = qs.get("style")      || "cartoon";
    const labels     = qs.get("labels")     || "1";
    const legend     = qs.get("legend")     || "1";
    const res_scores = qs.get("res_scores_csv") || "";
    const node_rmin  = qs.get("node_rmin")  || "0.35";
    const node_rmax  = qs.get("node_rmax")  || "1.0";
    const defaultK   = qs.get("kmin")       || "4";
    const defaultTop = qs.get("topk")       || (res_scores ? "10" : "");

    // UI state
    const topkInput  = document.getElementById("topk");
    const kminInput  = document.getElementById("kmin");
    topkInput.value  = defaultTop;
    kminInput.value  = defaultK;

    const iframe = document.getElementById("view");
    const btns = {
      cartoon: document.getElementById("btnCartoon"),
      overlay: document.getElementById("btnOverlay"),
      ball:    document.getElementById("btnBall"),
    };

    function buildUrl(mode){
      // Always use only known params to avoid 422s.
      const common = new URLSearchParams({
        pdb_path, edges_csv, style: baseStyle, labels, legend
      });

      // Cartoon: hide edges via very high kmin; drop attribution so only protein shows
      if(mode === "cartoon"){
        common.set("kmin", "9999");
      } else {
        // Overlay / Ball use provided kmin
        const km = (kminInput.value || defaultK);
        common.set("kmin", km);
        if(res_scores){
          common.set("res_scores_csv", res_scores);
          if(topkInput.value) common.set("topk", topkInput.value);
          common.set("node_rmin", node_rmin);
          common.set("node_rmax", node_rmax);
        }
      }

      // Ball-and-Stick approximation: emphasize nodes, hide legend if desired
      if(mode === "ball"){
        if(res_scores){
          // make spheres more visible
          common.set("node_rmin", "0.6");
          common.set("node_rmax", "1.3");
        }
        // optional: minimize UI by hiding legend
        common.set("legend", "0");
      }
      return "/viz/psn_net?" + common.toString();
    }

    function setMode(which){
      for (const k of Object.keys(btns)) btns[k].classList.remove("active");
      btns[which].classList.add("active");
      iframe.src = buildUrl(which);
    }

    document.getElementById("apply").onclick = () => {
      // reapply current active mode with updated k/topk
      if (btns.cartoon.classList.contains("active")) setMode("cartoon");
      else if (btns.ball.classList.contains("active")) setMode("ball");
      else setMode("overlay");
    };

    btns.cartoon.onclick = () => setMode("cartoon");
    btns.overlay.onclick = () => setMode("overlay");
    btns.ball.onclick    = () => setMode("ball");

    // initial
    setMode("overlay");
  </script>
</body>
</html>
